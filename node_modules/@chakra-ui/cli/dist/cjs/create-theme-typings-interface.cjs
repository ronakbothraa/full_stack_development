'use strict';

var extractColorSchemes = require('./extract-color-schemes.cjs');
var extractComponentTypes = require('./extract-component-types.cjs');
var extractPropertyKeys = require('./extract-property-keys.cjs');
var extractPropertyPaths = require('./extract-property-paths.cjs');
var extractSemanticTokenKeys = require('./extract-semantic-token-keys.cjs');
var formatWithPrettier = require('./utils/format-with-prettier.cjs');
var isObject = require('./utils/is-object.cjs');

function applyThemeTypingTemplate(typingContent, template) {
  switch (template) {
    case "augmentation":
      return `// regenerate by running
// npx @chakra-ui/cli tokens path/to/your/theme.(js|ts) --template augmentation --out path/to/this/file 
import { BaseThemeTypings } from "@chakra-ui/styled-system";
declare module "@chakra-ui/styled-system" {
  export interface CustomThemeTypings extends BaseThemeTypings {
    ${typingContent}
  }
}
`;
    case "default":
    default:
      return `// regenerate by running
// npx @chakra-ui/cli tokens path/to/your/theme.(js|ts)
import { BaseThemeTypings } from "./shared.types.js"
export interface ThemeTypings extends BaseThemeTypings {
  ${typingContent}
}
`;
  }
}
async function createThemeTypingsInterface(theme, {
  config,
  strictComponentTypes = false,
  format = true,
  strictTokenTypes = false,
  template = "default"
}) {
  const unions = config.reduce(
    (allUnions, { key, maxScanDepth, filter = () => true, flatMap = (value) => value }) => {
      const target = theme[key];
      allUnions[key] = [];
      if (isObject.isObject(target) || Array.isArray(target)) {
        allUnions[key] = extractPropertyPaths.extractPropertyPaths(target, maxScanDepth).filter(filter).flatMap(flatMap);
      }
      if (isObject.isObject(theme.semanticTokens)) {
        const semanticTokenKeys = extractSemanticTokenKeys.extractSemanticTokenKeys(theme, key).filter(filter).flatMap(flatMap);
        allUnions[key].push(...semanticTokenKeys);
      }
      return allUnions;
    },
    {}
  );
  const textStyles = extractPropertyKeys.extractPropertyKeys(theme, "textStyles");
  const layerStyles = extractPropertyKeys.extractPropertyKeys(theme, "layerStyles");
  const colorSchemes = extractColorSchemes.extractColorSchemeTypes(theme);
  const componentTypes = extractComponentTypes.extractComponentTypes(theme);
  const typingContent = `${extractPropertyPaths.printUnionMap(
    { ...unions, textStyles, layerStyles, colorSchemes },
    (targetKey) => targetKey === "conditions" ? true : strictTokenTypes
  )}

  ${extractComponentTypes.printComponentTypes(componentTypes, strictComponentTypes)}`;
  const themeTypings = applyThemeTypingTemplate(typingContent, template);
  return format ? formatWithPrettier.formatWithPrettier(themeTypings) : themeTypings;
}

exports.createThemeTypingsInterface = createThemeTypingsInterface;
